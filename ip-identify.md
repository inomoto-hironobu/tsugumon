tsugumonにおけるクライアントIP特定について
====

auther: [kmkc](https://github.com/kmkc/)  
date: 2019.1.12

Overview
--------

本ソフトウェア継問(以下tsugumon)は、IPアドレスをユーザーアカウントとして扱うアンケートソフトである。  
ここでは、私がtsugumonに持つ下記の疑問について記述する。

1. IPアドレスを一意のユーザとして扱うことの疑問
2. プロキシサーバを経由するなど、サーバからクライアントIPが隠蔽されるケースについて

Detail
------

### IPアドレスを一意のユーザとして扱うことの疑問

今日では、インターネット通信におけるクライアントデバイスは大多数がモバイル端末である。
モバイル端末はSIMカードを内蔵しており、大抵の場合はフローティングIPのSIMである。
IoTのプロジェクトなどは、個体識別のためにグローバルIPが割り振られたSIMカードを
契約する場合もあるが、これはtsugumonがアンケート対象とするユーザではない。

> グローバルIP: インターネット上にて一意のIPアドレス  
> フローティングIP: キャリアが自由に使えるIPアドレスを複数持っていて、ユーザがインターネット接続する際にそれを割り振る方式。接続するたびにIPアドレスが変わると考えて良い

#### 携帯端末が圏外から復帰するケースを考える

たとえば高速道路や電車等でトンネルを通る場合を考える。
トンネル内では電波が通じないため、端末は一度圏外の状態となり、その後復帰することになる。

このとき、トンネル通過前に割り振られていたIPをキャリアが再度割り振ればIPアドレスは変わらない。
しかし大抵の場合、通過前のIPアドレスが他人に割り振られるなどの原因で、通過後に割り振られるIPアドレスは別のものである場合が多い。

#### 社内LANや家庭内LANを考える

社内LANや家庭内LANでは、一般的にルータがインターネット上のIPを持っている。
（このIPアドレスもフローティングである場合が多い。ルータ再起動時にIPアドレスを取得する）  
したがって、サーバ側から見えるIPアドレスはこのルータのIPアドレスということになる。

> 試しに同じWi-fi経由でPCとスマホから下記URLに接続すると、同じIPアドレスであることがわかる
> http://www.ugtop.com/spill.shtml

ただし、この場合はパケット内にLAN内のデバイス毎のIPアドレス（宛先アドレス）が必ず含まれるため、パケット解析によってLAN内のデバイスを区別できるかもしれない。
当然、このケースにおいてもデバイスが再起動する等の要因で宛先アドレスが変わる場合がある。

### プロキシサーバを経由するなど、サーバからクライアントIPが隠蔽されるケースについて

攻撃者が自身のIPアドレスを隠蔽するためにプロキシサーバを何重にも経由する手法は、
クラッキングの常套手段として有名と思う。

プロキシサーバを1台挟んだ通信を仮定する。
プロキシを経由すると、クライアントとサーバ間にコネクションは無く、あるのは
[クライアント-プロキシ間]、[プロキシ-サーバ間]の通信のみであり、2つの通信は独立している。
サーバが受け取るパケットにはクライアントの情報が一切含まれないため、つまり相手の特定が不可能である。（厳密にはプロキシサーバがクライアントの情報をログとして持っている。ただし技術的にクライアントを調査するには個人レベルでは厳しいと思われる）
